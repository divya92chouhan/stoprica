%h1
  = @race.name

%h4
  Vrijeme utrke:
  %b
    = l @race.date, format: :long

- if @race.location_url.present?
  %h4
    %a{ href: @race.location_url, target: 'blank', style: "text-decoration: none" }
      %i.material-icons.is-vcentered location_on
      Lokacija utrke

- if @is_admin || @is_race_admin
  %h5
    %b
      Token ID:
      = @race.auth_token

- unless @race.started_at
  %h4
    Prijave otvorene do:
    %b#raceResultLocked{ class: @race.lock_race_results ? 'shame' : '' }
      = l @race.registration_threshold, format: :long
    - if @race.lock_race_results
      .mdl-tooltip.mdl-tooltip--large{for: "raceResultLocked"}
        %b Napomena:
        Odjave su onemogućene za ovu utrku.

- if @is_admin && @race.pool
  %h4
    Baza brojeva:
    = link_to @race.pool&.name, pool_path(@race.pool)
  %hr
  = form_tag import_racers_path, multipart: true do
    = file_field_tag :file
    = hidden_field_tag :race_id, @race.id
    = submit_tag 'Import'
  %hr

.race-actions
  = link_to races_path do
    .mdl-button.mdl-button--raised.mdl-button--accent.mdl-js-button.mdl-js-ripple-effect
      Natrag

  - if @is_admin || @is_race_admin
    = link_to assign_positions_race_path(@race) do
      .mdl-button.mdl-js-button.mdl-button--raised.mdl-button--colored.mdl-js-ripple-effect
        Azuriraj

    = link_to edit_race_path(@race) do
      .mdl-button.mdl-js-button.mdl-button--raised.mdl-button--colored.mdl-js-ripple-effect
        Izmijeni

- if @is_admin || @is_race_admin
  .race-actions
    %span
      Preuzimanje podataka

    = form_with url: export_race_path(@race) do
      = select_tag 'type', options_for_select([['Svi podaci', 'all'], ['Startna lista', 'start_list'], ['Rezultati', 'result'], ['Rezultati_UCI', 'result_with_uci']])
      = select_tag 'format', options_for_select([['Xlsx', 'xlsx'], ['Csv', 'csv']])
      = submit_tag 'Izvoz', class: 'mdl-button mdl-js-button mdl-button--raised mdl-button--accent mdl-js-ripple-effect'

%a{ href: @race.description_url, target: '_blank' }
  %h4
    Dodatne informacije

- if @is_admin || @is_race_admin
  = render 'admin_race_result_form'
- elsif @current_racer&.club_admin? && DateTime.now < @race.registration_threshold
  = render 'club_admin_form'

.race-actions
  - if DateTime.now < @race.registration_threshold
    - if user_signed_in? && !@racer_has_race_result
      = form_for RaceResult.new do |f|
        = f.hidden_field :racer_id, value: current_user.racer.try(:id)
        = f.hidden_field :race_id, value: @race.id
        = f.hidden_field :status, value: 1
        = f.select :category_id, @race.categories.collect{|c| [c.name, c.id]}, { prompt: 'Odaberi kategoriju' }, required: true
        - if @race.league&.xczld?
          .waiver
            %input{ type: 'checkbox', required: true }
            Ovim potvrđujem da sam pročitao i da se slažem s
            = link_to 'Izjavom o oslobađanju organizatora od odgovornosti', izjava_path, target: '_blank'
        - if @race.id == 117
          .waiver
            %input{ type: 'checkbox', required: true }
              #waiver
                Ovim potvrđujem da sam pročitao i da se slažem s Izjavom o oslobađanju organizatora od odgovornosti
              .mdl-tooltip.mdl-tooltip--large{ 'data-mdl-for': 'waiver', style: 'max-width: 90%' }
                Ovom izjavom potvrđujem da na Utrci nastupam isključivo na vlastitu odgovornost, svjestan da sudjelovanje na ovoj utrci predstavlja potencijalnu opasnost koja uključuje rizik od raznih vrsta tjelesnih ozljeda i moguću smrt.
                <br>
                Prihvaćam da Organizator nije odgovoran za bilo koji oblik štete prema meni koji je nastao sudjelovanjem na natjecanju, posredno, neposredno, izdvojeno ili povezano, izazvan vlastitom nepažnjom i krivnjom, ili nepažnjom i krivnjom drugih natjecatelja ili trećih osoba, prije, za vrijeme ili nakon spomenutog natjecanja.
                <br>
                Osobno sam odgovoran/na za bilo koji oblik štete prema trećim osobama koju  prouzročim ili kojoj doprinesem vlastitom nepažnjom ili krivnjom.
                <br>
                Za vrijeme trajanja Utrke, te neposredno prije i poslije iste, poštivati ću službeno objavljena pravila, upute o sigurnom kretanju, i uvjete nastupa izdanih od strane organizatora, te upute sudaca, redara i osoba angažiranih u organizaciji utrke na terenu.
                <br>
                Odričem se prava da sudskim putem potražujem od organizatora naknadu bilo kojeg oblika za štete nastale sudjelovanjem na Utrci.
                <br>
                Prihvaćam da se za sve sporove ugovara nadležnost Općinskog suda u Zadru, prema zakonima Republike Hrvatske.
                <br>
        = f.submit 'Prijavi se', class: 'mdl-button mdl-js-button mdl-button--raised mdl-button--accent mdl-js-ripple-effect'
    - elsif user_signed_in? && @racer_has_race_result
      - unless @race.lock_race_results
        = form_for @race_result, method: 'DELETE' do |f|
          .actions
            = f.submit 'Odjavi se', class: 'mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect'
    - else
      = link_to 'Login za prijavu', login_racers_path(redirect: "/races/#{@race.id}"), class: 'mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect', style: 'margin: 0'

%h4
  Natjecatelji

- if @race.started_at
  %label.mdl-switch.mdl-js-switch.mdl-js-ripple-effect{for: "poredak"}
    %input#poredak.mdl-switch__input{checked: params[:absolute], type: "checkbox"}
    %span.mdl-switch__label Generalni poredak

%p
  = render 'race_results_count'


- if @race.penjanje?
  = render 'climbing_results'
- else
  = render 'results'

:javascript
  var forms = document.querySelectorAll('#adminFormContainer form.edit_race_result');

  for(var i = forms.length - 1; i >= 0; i--) {
    forms[i].addEventListener('submit', submitAsync);
  }

  function submitAsync(e) {
    e.preventDefault();

    var xhr = new XMLHttpRequest();
    var form = this;

    xhr.onreadystatechange = function() {
      if (this.readyState === 4) {
        if (this.status === 200) {
          var res = JSON.parse(xhr.responseText);
          var startNumber = res.start_number ? res.start_number.value : '';
          var raceId = res.start_number ? res.race_id : '';
          form.style.border = '2px solid green';
          alert('Spremljen broj ' + startNumber);
        }
        else {
          form.style.border = '2px solid red';
          alert('GRESKA. Nije spremljeno.');
        }
      }
    };

    xhr.open('POST', this.action, true);
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.send(new FormData(this));

    return false;
  }

:javascript
  document.querySelector('#poredak').addEventListener('click', function(event) {
    var checked = event.target.checked;
    if (checked) window.location.search = 'absolute=true';
    else window.location.search = '';
  });
